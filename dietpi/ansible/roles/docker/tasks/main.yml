---
- name: Check if Docker is already installed
  ansible.builtin.command: which docker
  register: docker_check
  changed_when: false
  failed_when: false

- name: Install Docker using official script
  ansible.builtin.shell: |
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
  args:
    creates: /usr/bin/docker
  become: yes
  when: docker_check.rc != 0

- name: Add all users to docker group
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: docker
    append: yes
  become: yes
  loop: "{{ new_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Unmask Docker service
  ansible.builtin.systemd:
    name: docker
    masked: no
  become: yes

- name: Enable and start Docker service
  ansible.builtin.systemd:
    name: docker
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  ansible.builtin.debug:
    msg: "Docker installed: {{ docker_version.stdout }}"

- name: Install docker-compose-plugin from repository
  ansible.builtin.apt:
    name: docker-compose-plugin
    state: present
    update_cache: yes
  become: yes

- name: Ensure user bin directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/bin"
    state: directory
    mode: '0755'

- name: Create symlink to docker-compose in user bin
  ansible.builtin.file:
    src: /usr/libexec/docker/cli-plugins/docker-compose
    dest: "{{ ansible_env.HOME }}/bin/docker-compose"
    state: link
    force: yes

- name: Verify docker-compose installation
  ansible.builtin.command: docker compose version
  register: compose_version
  changed_when: false

- name: Display docker-compose version
  ansible.builtin.debug:
    msg: "docker-compose installed: {{ compose_version.stdout }}"

##### CONTAINER DEPLOYMENT #####
- name: Stop and remove containers with volumes (when cleaning)
  ansible.builtin.shell: |
    if [ -d "{{ containers_remote_directory }}/{{ item }}" ]; then
      cd {{ containers_remote_directory }}/{{ item }} && docker compose down -v --remove-orphans
    fi
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when:
    - containers_upload_files
    - item in containers_clean_on_deploy
  failed_when: false

- name: Remove all volumes associated with containers (when cleaning)
  ansible.builtin.shell: |
    docker volume ls -q | grep -E '^{{ item }}' | xargs -r docker volume rm
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when:
    - containers_upload_files
    - item in containers_clean_on_deploy
  failed_when: false

- name: Remove all networks associated with containers (when cleaning)
  ansible.builtin.shell: |
    docker network ls -q --filter name={{ item }} | xargs -r docker network rm
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when:
    - containers_upload_files
    - item in containers_clean_on_deploy
  failed_when: false

- name: Remove container directories (when cleaning)
  ansible.builtin.file:
    path: "{{ containers_remote_directory }}/{{ item }}"
    state: absent
  become: yes
  loop: "{{ containers_installs }}"
  when:
    - containers_upload_files
    - item in containers_clean_on_deploy

- name: Create containers directory
  ansible.builtin.file:
    path: "{{ containers_remote_directory }}"
    state: directory
    owner: "{{ new_users[0].name }}"
    group: "{{ new_users[0].name }}"
    mode: '0755'
  become: yes
  when: containers_upload_files

- name: Copy container directories
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../containers/{{ item }}/"
    dest: "{{ containers_remote_directory }}/{{ item }}/"
    owner: "{{ new_users[0].name }}"
    group: "{{ new_users[0].name }}"
    mode: '0755'
  become: yes
  loop: "{{ containers_installs }}"
  when: containers_upload_files

- name: Pull latest container images (before stopping)
  ansible.builtin.shell: docker compose pull
  args:
    chdir: "{{ containers_remote_directory }}/{{ item }}"
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when: containers_upload_files

- name: Stop and remove existing containers
  ansible.builtin.shell: docker compose down
  args:
    chdir: "{{ containers_remote_directory }}/{{ item }}"
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when: containers_upload_files
  failed_when: false

- name: Start Docker containers with updated images
  ansible.builtin.shell: docker compose up -d
  args:
    chdir: "{{ containers_remote_directory }}/{{ item }}"
  become_user: "{{ new_users[0].name }}"
  loop: "{{ containers_installs }}"
  when: containers_upload_files
